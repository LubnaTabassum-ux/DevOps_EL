# deployment/playbook.yaml
- name: Deploy Secure Docker Image to Kubernetes
  hosts: localhost
  connection: local
  vars:
    app_name: "{{ lookup('env', 'APP_NAME') }}"
    image_tag: "{{ lookup('env', 'IMAGE_TAG') }}"
    # CHANGE: Point this to the Jenkins-accessible path we created earlier
    kube_config_file: "/var/lib/jenkins/.kube/config"

  tasks:
    - name: Ensure Kubectl is accessible
      command: kubectl cluster-info
      register: kube_check
      changed_when: false
      failed_when: kube_check.rc != 0
      
    - name: Substitute image tag in Kubernetes manifest
      template:
        src: deployment.yaml.j2 
        dest: /tmp/deployment-rendered.yaml
      vars:
        APP_NAME: "{{ app_name }}"
        IMAGE_TAG: "{{ image_tag }}"

    - name: Apply Kubernetes Deployment and Service
      kubernetes.core.k8s:
        state: present
        src: /tmp/deployment-rendered.yaml
        kubeconfig: "{{ kube_config_file }}"
        # CHANGE: Added explicit namespace here to fix the error
        namespace: default
        
    - name: Verify Deployment Status
      # CHANGE: Renamed this task for clarity (it was a duplicate name)
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ app_name }}-deployment"
        namespace: default
      register: deploy_info
      # Optional: Keep the wait logic if you want the pipeline to confirm the pods are ready
